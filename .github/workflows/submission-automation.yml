name: Submission Issue Automation

on:
  issues:
    types: [closed]

permissions:
  contents: write
  issues: write

concurrency:
  group: hackathon-automation
  cancel-in-progress: false

jobs:
  check-registration:
    runs-on: ubuntu-latest
    if: github.event.action == 'closed' && startsWith(github.event.issue.title, 'Submission')
    outputs:
      user-registered: ${{ steps.check-user.outputs.registered }}
    steps:
      - name: Wait for potential registration workflow
        run: |
          echo "â³ ç­‰å¾…å¯èƒ½çš„æ³¨å†Œå·¥ä½œæµå®Œæˆ..."
          echo "è¿™ç¡®ä¿åœ¨æ‰¹é‡å…³é—­ issue æ—¶ï¼Œæ³¨å†Œå·¥ä½œæµèƒ½å…ˆæ‰§è¡Œ"
          sleep 30
          
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Check if user is registered
        id: check-user
        run: |
          USER="${{ github.event.issue.user.login }}"
          
          # æ£€æŸ¥å¤šæ¬¡ï¼Œç»™æ³¨å†Œå·¥ä½œæµæ›´å¤šæ—¶é—´å®Œæˆ
          for i in {1..3}; do
            if [ -f "registration/${USER}.md" ]; then
              echo "registered=true" >> $GITHUB_OUTPUT
              echo "âœ… User ${USER} is registered"
              exit 0
            else
              echo "âŒ User ${USER} registration file not found (attempt $i/3)"
              if [ $i -lt 3 ]; then
                echo "â³ ç­‰å¾… 15 ç§’åé‡è¯•..."
                sleep 15
                # é‡æ–°æ‹‰å–æœ€æ–°ä»£ç 
                git pull origin main || true
              fi
            fi
          done
          
          echo "registered=false" >> $GITHUB_OUTPUT
          echo "âŒ User ${USER} is not registered after 3 attempts"

  process-submission:
    runs-on: ubuntu-latest
    needs: check-registration
    if: needs.check-registration.outputs.user-registered == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Submission Info, Create Project Folder and Update Table
        id: extract-submission
        run: |
          node materials/scripts/submission_extract.js
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_USER: ${{ github.event.issue.user.login }}

      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.payload.issue.number;
            try {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: `âœ… Submission processed successfully!\n\n- é¡¹ç›®ä¿¡æ¯å·²å½’æ¡£\n- README.md Submission åŒºåŸŸå·²è‡ªåŠ¨æ›´æ–°\n\næ„Ÿè°¢ä½ çš„æäº¤ï¼ğŸ‰`
              });
              console.log(`Comment posted on issue #${issue_number}`);
            } catch (error) {
              console.error(`Error posting comment: ${error.message}`);
              core.setFailed(`Error posting comment: ${error.message}`);
            }

  handle-unregistered:
    runs-on: ubuntu-latest
    needs: check-registration
    if: needs.check-registration.outputs.user-registered == 'false'
    steps:
      - name: Comment on issue for unregistered user
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.payload.issue.number;
            const user = '${{ github.event.issue.user.login }}';
            
            try {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: `âŒ æäº¤å¤±è´¥ï¼šç”¨æˆ·æœªæ³¨å†Œ\n\n@${user} æ‚¨éœ€è¦å…ˆå®Œæˆæ³¨å†Œæ‰èƒ½æäº¤é¡¹ç›®ã€‚\n\nè¯·å…ˆåˆ›å»ºä¸€ä¸ªæ³¨å†Œ Issueï¼š\n- å‰å¾€ [Issues](${context.payload.repository.html_url}/issues/new)\n- é€‰æ‹© "Registration" æ¨¡æ¿\n- å¡«å†™æ‚¨çš„ä¸ªäººä¿¡æ¯\n- ç­‰å¾…æ³¨å†Œå®Œæˆåå†æäº¤é¡¹ç›®\n\næ³¨å†Œå®Œæˆåï¼Œè¯·é‡æ–°åˆ›å»ºæäº¤ Issueã€‚\n\næ„Ÿè°¢æ‚¨çš„ç†è§£ï¼ğŸ™`
              });
              
              // é‡æ–°æ‰“å¼€ issueï¼Œè¿™æ ·ç”¨æˆ·èƒ½çœ‹åˆ°è¯„è®º
              await github.rest.issues.update({
                owner,
                repo,
                issue_number,
                state: 'open'
              });
              
              console.log(`Comment posted and issue reopened for unregistered user: ${user}`);
            } catch (error) {
              console.error(`Error handling unregistered user: ${error.message}`);
              core.setFailed(`Error handling unregistered user: ${error.message}`);
            }